<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>SCADA Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    main {
      display: flex;
      flex-direction: row;
      gap: 20px;
      padding: 20px;
    }

    .vfd-container {
      flex: 1;
      background: #1f1f1f;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
      color: #f5f5f5;
      font-weight: 500;
      text-transform: uppercase;
    }

    .live-data {
      margin-bottom: 20px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin: 8px 0;
      font-size: 0.95rem;
      background: #2b2b2b;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #444;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    canvas {
      width: 100% !important;
      background: #121212;
      border: 1px solid #333;
      border-radius: 6px;
      aspect-ratio: 2 / 1;
    }
  </style>
</head>
<body>

{% set page_title = "Masseiras - Ao Vivo" %}
{% include "header.html" %}

  <main>
    <div class="vfd-container">
      <h2>Masseira 1</h2>
      <div id="live-Masseira_1" class="live-data"></div>
      <div class="charts-grid">
        <canvas id="chart-Masseira_1-RPM"></canvas>
        <canvas id="chart-Masseira_1-OutputFrequency"></canvas>
        <canvas id="chart-Masseira_1-CurrentMagnitude"></canvas>
        <canvas id="chart-Masseira_1-PercentageLoad"></canvas>
        <canvas id="chart-Masseira_1-OutputPower"></canvas>
      </div>
    </div>

    <div class="vfd-container">
      <h2>Masseira 2</h2>
      <div id="live-Masseira_2" class="live-data"></div>
      <div class="charts-grid">
        <canvas id="chart-Masseira_2-RPM"></canvas>
        <canvas id="chart-Masseira_2-OutputFrequency"></canvas>
        <canvas id="chart-Masseira_2-CurrentMagnitude"></canvas>
        <canvas id="chart-Masseira_2-PercentageLoad"></canvas>
        <canvas id="chart-Masseira_2-OutputPower"></canvas>
      </div>
    </div>
  </main>

  <script>
    const devices = ["Masseira_1", "Masseira_2"];
    const tags = ["RPM", "OutputFrequency", "CurrentMagnitude", "PercentageLoad", "OutputPower"];
    let meta = {};

    const charts = {};
    const colors = ["#00bfff", "#28a745", "#ffc107", "#ff4500", "#9370db"];

    async function fetchMeta() {
      const res = await fetch("/api/meta");
      meta = await res.json();
    }

    function initCharts() {
      devices.forEach(device => {
        charts[device] = {};
        tags.forEach((tag, index) => {
          const ctx = document.getElementById(`chart-${device}-${tag}`).getContext("2d");
          charts[device][tag] = new Chart(ctx, {
            type: "line",
            data: {
              labels: [],
              datasets: [{
                label: `${tag} (${meta[tag].unit})`,
                data: [],
                borderColor: colors[index % colors.length],
                backgroundColor: "transparent",
                fill: false,
                tension: 0.3
              }]
            },
            options: {
              animation: false,
              responsive: true,
              maintainAspectRatio: true,
              aspectRatio: 4,
              plugins: {
                legend: { labels: { color: "#e0e0e0" } }
              },
              scales: {
                y: {
                  title: {
                    display: true,
                    text: `${tag} (${meta[tag].unit})`,
                    color: "#e0e0e0"
                  },
                  ticks: { color: "#c0c0c0" },
                  grid: { color: "#333" }
                },
                x: {
                  ticks: { autoSkip: true, maxTicksLimit: 10, color: "#c0c0c0" },
                  grid: { color: "#333" }
                }
              }
            }
          });
        });
      });
    }

    async function fetchLiveData() {
      const res = await fetch("/api/live");
      const data = await res.json();

      devices.forEach(device => {
        let html = "<ul>";
        tags.forEach(tag => {
          html += `<li><strong>${tag}:</strong> ${data[device][tag]} ${meta[tag].unit}</li>`;
        });
        html += "</ul>";
        document.getElementById(`live-${device}`).innerHTML = html;

        tags.forEach(tag => {
          const chart = charts[device][tag];
          const now = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          chart.data.labels.push(now);
          chart.data.datasets[0].data.push(data[device][tag]);

          if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
          }
          chart.update();
        });
      });
    }

    async function start() {
      await fetchMeta();
      initCharts();
      fetchLiveData();
      setInterval(fetchLiveData, 2000);
    }

    start();
  </script>

</body>
</html>
