<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Resumo Produção</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    :root { --gap: 16px; --card-pad: 12px; --mini-chart-h: 120px; }
    .container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--gap);
      padding: 16px;
    }
    .left, .right { display: flex; flex-direction: column; gap: var(--gap); }
    .card {
      background: #1f1f1f;
      padding: var(--card-pad);
      border-radius: 8px;
      border: 1px solid #333;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .card h3, .card h2 { margin: 0 0 8px; color: #fff; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .masseira-block {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: center;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
    table th, table td { padding: 3px; border-bottom: 1px solid #333; text-align: center; color: #ff6229; }
    table th { color: #e0e0e0; }
    .chart-container { width: 100%; height: 240px; }
    canvas {
      background: #121212; border-radius: 6px; padding: 4px;
      width: 100% !important; height: 100% !important;
    }
    /* Status ball */
    .status-ball { display: inline-block; width: 12px; height: 12px; border-radius: 50%; vertical-align: middle; }
    .status-ball.green { background-color: #00ff00; }
    .status-ball.red { background-color: #ff3b30; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }
    .status-ball.blink { animation: blink .8s ease-in-out 1; }

    /* Mini tanks grid */
    .mini-tanks-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .mini-tank {
      display: grid;
      grid-template-rows: auto var(--mini-chart-h) auto;
      gap: 6px;
    }
    .mini-title {
      display: flex; align-items: center; justify-content: space-between;
      color: #eaeaea; font-size: .9rem; padding: 0 2px;
    }
    .mini-canvas { height: var(--mini-chart-h); }
    .mini-meta { color: #cfcfcf; font-size: .85rem; text-align: center; }

    /* Masseira live metrics (compact) */
    .live-metrics {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
      margin-top: 6px; color: #cfcfcf; font-size: .9rem; text-align: center;
    }

    /* Tentar evitar scroll: diminuir espaços em telas menores */
    @media (max-height: 840px) {
      .chart-container { height: 200px; }
      :root { --mini-chart-h: 100px; }
    }
    @media (max-height: 760px) {
      .chart-container { height: 180px; }
      :root { --mini-chart-h: 90px; }
    }
  </style>
</head>
<body>
{% set page_title = "  - Resumo Produção" %}
{% include "header.html" %}

<div class="container">
  <!-- Lado Esquerdo: Masseiras empilhadas -->
  <div class="left">
    <div class="card">
      <h2>Masseira 1 <span id="status-m1" class="status-ball red"></span></h2>
      <div class="masseira-block">
        <table id="table-m1"></table>
        <div>
          <div class="chart-container">
            <canvas id="graph-m1"></canvas>
          </div>
          <div class="live-metrics">
            <div>Frequência: <strong><span id="m1-freq">—</span></strong> Hz</div>
            <div>Corrente: <strong><span id="m1-corr">—</span></strong> A</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Masseira 2 <span id="status-m2" class="status-ball red"></span></h2>
      <div class="masseira-block">
        <table id="table-m2"></table>
        <div>
          <div class="chart-container">
            <canvas id="graph-m2"></canvas>
          </div>
          <div class="live-metrics">
            <div>Frequência: <strong><span id="m2-freq">—</span></strong> Hz</div>
            <div>Corrente: <strong><span id="m2-corr">—</span></strong> A</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lado Direito: Totais + A Definir -->
  <div class="right">
    <div class="card" id="materias">
      <h3>Consumo Total - Matérias Primas</h3>
      <table id="table-materias"></table>
    </div>

    <div class="card" id="totais">
      <h3>Total Geral</h3>
      <table id="table-totais"></table>
    </div>

    <div class="card" id="adefinir">
      <h3>Tanques — Resumo ao Vivo</h3>
      <div class="mini-tanks-grid">
        <div class="mini-tank">
          <div class="mini-title">
            <span>Resina Acrílica</span>
            <span id="status-RA" class="status-ball red"></span>
          </div>
          <div class="mini-canvas"><canvas id="lvl-RA"></canvas></div>
          <div class="mini-meta">Peso: <strong><span id="peso-RA">—</span></strong> kg</div>
        </div>

        <div class="mini-tank">
          <div class="mini-title">
            <span>Resina Veova</span>
            <span id="status-RV" class="status-ball red"></span>
          </div>
          <div class="mini-canvas"><canvas id="lvl-RV"></canvas></div>
          <div class="mini-meta">Peso: <strong><span id="peso-RV">—</span></strong> kg</div>
        </div>

        <div class="mini-tank">
          <div class="mini-title">
            <span>Água 1</span>
            <span id="status-A1" class="status-ball red"></span>
          </div>
          <div class="mini-canvas"><canvas id="lvl-A1"></canvas></div>
          <div class="mini-meta">Peso: <strong><span id="peso-A1">—</span></strong> kg</div>
        </div>

        <div class="mini-tank">
          <div class="mini-title">
            <span>Água 2</span>
            <span id="status-A2" class="status-ball red"></span>
          </div>
          <div class="mini-canvas"><canvas id="lvl-A2"></canvas></div>
          <div class="mini-meta">Peso: <strong><span id="peso-A2">—</span></strong> kg</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================================================================================
   BLOCO 1 — Overview (tabelas) — mantém, sem replotar gráficos
   Agora busca tudo de uma vez em /api/overview_multi?periods=...
======================================================================================= */
const PERIODS = [
  { key: "hoje",  label: "Hoje" },
  { key: "7d",    label: "7d" },
  { key: "mtd",   label: "Mês" },
  { key: "30d",   label: "30d" },
  { key: "ytd",   label: "YTD" }
];
const charts = {};        // charts de linha das masseiras (live)
const miniCharts = {};    // charts de barra dos tanques (card A Definir)
const LIVE_CHART_MAX_POINTS = 180; // ~15 min com refresh de 5s
let refreshTimer = null;   // tabelas
let refreshTimer5s = null; // live

function fmt(v) {
  if (v === null || v === undefined || Number.isNaN(v)) return "—";
  if (typeof v === "number") {
    const isIntLike = Math.abs(v - Math.round(v)) < 1e-9;
    return v.toLocaleString("pt-BR", {
      maximumFractionDigits: isIntLike ? 0 : 2,
      minimumFractionDigits: isIntLike ? 0 : 2
    });
  }
  return String(v);
}
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }

async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error(`HTTP ${res.status} em ${url}`);
  return res.json();
}

/** NOVO: busca todos os períodos em uma única chamada */
async function fetchOverviewMulti(periodKeys) {
  const qs = encodeURIComponent(periodKeys.join(','));
  return fetchJSON(`/api/overview_multi?periods=${qs}`);
}

/** Fallback legado: busca um período por vez (usado se o multi não existir) */
async function fetchOverview(period) {
  return fetchJSON(`/api/overview?period=${encodeURIComponent(period)}`);
}

function tableHeader() {
  const cols = PERIODS.map(p => `<th>${p.label}</th>`).join("");
  return `<tr><th>Métrica</th>${cols}</tr>`;
}

function valuesAcrossPeriods(dataByPeriod, pathFn) {
  return PERIODS.map(p => {
    const d = dataByPeriod[p.key];
    try { return fmt(pathFn(d)); } catch { return "—"; }
  });
}

function renderMasseiraTable(masseiraName, tableId, dataByPeriod) {
  const rows = [];
  const getM = (d, f) => d?.masseiras?.[masseiraName]?.[f];

  rows.push(["Nº Taxadas",           valuesAcrossPeriods(dataByPeriod, d => getM(d, "num_taxadas"))]);
  rows.push(["Horas Operação",       valuesAcrossPeriods(dataByPeriod, d => getM(d, "horas_operacao"))]);
  rows.push(["Tempo Médio (min)",    valuesAcrossPeriods(dataByPeriod, d => getM(d, "tempo_medio_taxada_min"))]);
  rows.push(["Energia (kWh)",        valuesAcrossPeriods(dataByPeriod, d => getM(d, "energia_kWh"))]);
  rows.push(["Energia/Taxada (kWh)", valuesAcrossPeriods(dataByPeriod, d => getM(d, "energia_por_taxada_kWh"))]);
  rows.push(["Corrente Máx (A)",     valuesAcrossPeriods(dataByPeriod, d => getM(d, "corrente_max_A"))]);
  rows.push(["Água Dosada",          valuesAcrossPeriods(dataByPeriod, d => getM(d, "agua_dosada"))]);
  rows.push(["Água (Real)",          valuesAcrossPeriods(dataByPeriod, d => getM(d, "agua_real_dosada"))]);
  rows.push(["Resina Dosada",        valuesAcrossPeriods(dataByPeriod, d => getM(d, "resina_dosada"))]);
  rows.push(["Resina (Real)",        valuesAcrossPeriods(dataByPeriod, d => getM(d, "resina_real_dosada"))]);

  const html = tableHeader() + rows.map(([label, vals]) =>
    `<tr><td>${label}</td>${vals.map(v => `<td>${v}</td>`).join("")}</tr>`).join("");

  document.getElementById(tableId).innerHTML = html;
}

function renderMateriasTable(tableId, dataByPeriod) {
  const getAgg = (d, f) => d?.materias_primas?.[f];
  const rows = [];
  rows.push(["Resina Dosada", valuesAcrossPeriods(dataByPeriod, d => getAgg(d, "resina_dosada"))]);
  rows.push(["Resina (Real)", valuesAcrossPeriods(dataByPeriod, d => getAgg(d, "resina_real"))]);
  rows.push(["Água Dosada",   valuesAcrossPeriods(dataByPeriod, d => getAgg(d, "agua_dosada"))]);
  rows.push(["Água (Real)",   valuesAcrossPeriods(dataByPeriod, d => getAgg(d, "agua_real"))]);

  const html = tableHeader() + rows.map(([label, vals]) =>
    `<tr><td>${label}</td>${vals.map(v => `<td>${v}</td>`).join("")}</tr>`).join("");

  document.getElementById(tableId).innerHTML = html;
}

function renderTotaisTable(tableId, dataByPeriod) {
  const getTot = (d, f) => d?.totais_gerais?.[f];
  const rows = [];
  rows.push(["Total Taxadas",       valuesAcrossPeriods(dataByPeriod, d => getTot(d, "total_taxadas"))]);
  rows.push(["Horas Operação",      valuesAcrossPeriods(dataByPeriod, d => getTot(d, "horas_operacao"))]);
  rows.push(["Energia Total (kWh)", valuesAcrossPeriods(dataByPeriod, d => getTot(d, "energia_kWh"))]);

  const html = tableHeader() + rows.map(([label, vals]) =>
    `<tr><td>${label}</td>${vals.map(v => `<td>${v}</td>`).join("")}</tr>`).join("");

  document.getElementById(tableId).innerHTML = html;
}

async function loadOverviewAllPeriods() {
  const periodKeys = PERIODS.map(p => p.key);
  let dataByPeriod = {};

  try {
    // Tenta rota nova (multi)
    const multi = await fetchOverviewMulti(periodKeys);
    // multi já deve vir como { hoje: {...}, '7d': {...}, ... }
    dataByPeriod = multi || {};
  } catch (errMulti) {
    console.warn("overview_multi indisponível, caindo para chamadas individuais:", errMulti);
    // Fallback: chamadas individuais (mantém compatibilidade)
    const results = await Promise.allSettled(periodKeys.map(fetchOverview));
    results.forEach((r, i) => dataByPeriod[periodKeys[i]] = r.status === "fulfilled" ? r.value : null);
  }

  renderMasseiraTable("Masseira_1", "table-m1", dataByPeriod);
  renderMasseiraTable("Masseira_2", "table-m2", dataByPeriod);
  renderMateriasTable("table-materias", dataByPeriod);
  renderTotaisTable("table-totais", dataByPeriod);
}

/* =======================================================================================
   BLOCO 2 — Live (/api/live): tanques + gráficos das masseiras (rolling)
======================================================================================= */
const tankMapping = {
  "Tanque_1_Resina": { chart: "lvl-RA", peso: "peso-RA", status: "status-RA", max: 500 },
  "Tanque_2_Resina": { chart: "lvl-RV", peso: "peso-RV", status: "status-RV", max: 500 },
  "Tanque_1_Agua":   { chart: "lvl-A1", peso: "peso-A1", status: "status-A1", max: 2500 },
  "Tanque_2_Agua":   { chart: "lvl-A2", peso: "peso-A2", status: "status-A2", max: 2500 }
};

function setStatusBall(elId, isActive) {
  const el = document.getElementById(elId);
  el.className = `status-ball ${isActive ? 'green' : 'red'}`;
  if (isActive) {
    el.classList.add('blink');
    setTimeout(() => el.classList.remove('blink'), 800);
  }
}

function createMiniBarChart(canvasId, maxValue) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  return new Chart(ctx, {
    type: 'bar',
    data: { labels: [''], datasets: [{ data: [0], backgroundColor: '#00bfff', borderRadius: 5 }] },
    options: {
      plugins: { legend: { display: false } },
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { display: false } },
        y: { min: 0, max: maxValue, grid: { color: '#333' }, ticks: { color: '#e0e0e0' } }
      }
    }
  });
}

function createLiveLineChart(canvasId) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  return new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { label: "Frequência (Hz)", data: [], borderColor: "#00bfff", fill: false },
        { label: "Corrente (A)",    data: [], borderColor: "#ff4500", fill: false }
      ]
    },
    options: {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#e0e0e0" } } },
      scales: {
        x: { ticks: { color: "#c0c0c0", maxTicksLimit: 6, autoSkip: true }, grid: { color: "#333" } },
        y: { ticks: { color: "#c0c0c0" }, grid: { color: "#333" } }
      }
    }
  });
}

function pushLivePoint(chart, label, freqVal, corrVal) {
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(toNum(freqVal)); // pode ser null => "gap" visual
  chart.data.datasets[1].data.push(toNum(corrVal));
  if (chart.data.labels.length > LIVE_CHART_MAX_POINTS) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
    chart.data.datasets[1].data.shift();
  }
  chart.update('none');
}

// cria mini charts (tanques) e gráficos de linha (masseiras) uma vez
for (const dev in tankMapping) {
  const { chart, max } = tankMapping[dev];
  miniCharts[chart] = createMiniBarChart(chart, max);
}
charts["graph-m1"] = createLiveLineChart("graph-m1");
charts["graph-m2"] = createLiveLineChart("graph-m2");

async function fetchLiveAndRender() {
  try {
    const live = await fetchJSON('/api/live');

    // Atualiza TANQUES no card “A Definir”
    for (const dev in tankMapping) {
      const ids = tankMapping[dev];
      const t = live[dev];
      const pesoVal = t ? t["Peso"] : null;

      setStatusBall(ids.status, pesoVal !== null && pesoVal !== undefined);

      const chart = miniCharts[ids.chart];
      chart.data.datasets[0].data[0] = (typeof pesoVal === 'number') ? pesoVal : 0;
      chart.update('none');
      document.getElementById(ids.peso).textContent = fmt(pesoVal);
    }

    // Atualiza MASSEIRAS: status + freq/corrente ao vivo + adiciona pontos nos gráficos
    const m1 = live["Masseira_1"] || {};
    const m2 = live["Masseira_2"] || {};
    const m1Active = [m1.OutputFrequency, m1.CurrentMagnitude, m1.OutputPower, m1.PercentageLoad, m1.RPM]
      .some(v => v !== null && v !== undefined);
    const m2Active = [m2.OutputFrequency, m2.CurrentMagnitude, m2.OutputPower, m2.PercentageLoad, m2.RPM]
      .some(v => v !== null && v !== undefined);

    setStatusBall('status-m1', m1Active);
    setStatusBall('status-m2', m2Active);

    document.getElementById('m1-freq').textContent = fmt(m1.OutputFrequency);
    document.getElementById('m1-corr').textContent = fmt(m1.CurrentMagnitude);
    document.getElementById('m2-freq').textContent = fmt(m2.OutputFrequency);
    document.getElementById('m2-corr').textContent = fmt(m2.CurrentMagnitude);

    const label = new Date().toLocaleTimeString('pt-BR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    pushLivePoint(charts["graph-m1"], label, m1.OutputFrequency, m1.CurrentMagnitude);
    pushLivePoint(charts["graph-m2"], label, m2.OutputFrequency, m2.CurrentMagnitude);

  } catch (err) {
    console.error('Erro ao buscar /api/live:', err);
    setStatusBall('status-m1', false);
    setStatusBall('status-m2', false);
    for (const dev in tankMapping) setStatusBall(tankMapping[dev].status, false);
  }
}

/* =======================================================================================
   Inicialização
======================================================================================= */
async function init() {
  // Overview inicial + refresh (apenas tabelas), agora com chamada única
  await loadOverviewAllPeriods();
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(loadOverviewAllPeriods, 30 * 60 * 1000); // 30 min

  // Live inicial + refresh a cada 5s (também atualiza gráficos de linha)
  await fetchLiveAndRender();
  if (refreshTimer5s) clearInterval(refreshTimer5s);
  refreshTimer5s = setInterval(fetchLiveAndRender, 5000);
}

init();

// limpar timers ao sair
window.addEventListener('beforeunload', () => {
  if (refreshTimer) clearInterval(refreshTimer);
  if (refreshTimer5s) clearInterval(refreshTimer5s);
});
</script>
</body>
</html>
