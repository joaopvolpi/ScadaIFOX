<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consumo DiÃ¡rio</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <style>
    main { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .filters { display: flex; align-items: center; gap: 12px; margin: 10px 0 16px 0; flex-wrap: wrap; }
    .chart-container {
      background: #1f1f1f;
      border: 1px solid #333;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 16px;
      position: relative;
    }
    .metric-badge {
      position: absolute;
      top: 14px;
      right: 16px;
      background: #0f172a;
      border: 1px solid #334155;
      color: #e2e8f0;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.2;
      text-align: right;
      min-width: 160px;
    }
    .metric-badge .value {
      display: block;
      font-size: 22px;
      font-weight: 700;
      margin-top: 2px;
    }
    canvas {
      width: 100% !important;
      height: 560px !important;
      background: #121212;
      border: 1px solid #333;
      border-radius: 6px;
    }
  </style>
</head>
<body>
{% set page_title = "  - Consumo DiÃ¡rio" %}
{% include "header.html" %}

<main>
  <div class="filters">
    <label>PerÃ­odo:
      <select id="periodo">
        <option value="30d" selected>Ãšltimos 30 dias</option>
        <option value="7d">Ãšltimos 7 dias</option>
        <option value="mtd">MÃªs atual</option>
        <option value="ytd">Ano atual</option>
      </select>
    </label>

    <label>Data base:
      <input type="text" id="dataBase" placeholder="YYYY-MM-DD">
    </label>

    <button id="btnCarregar">Carregar</button>
  </div>

  <!-- GrÃ¡fico 1 -->
  <div class="chart-container">
    <div class="metric-badge" id="metricCapacidade">
      % Capacidade total:
      <span class="value" id="metricCapacidadeValor">â€“</span>
    </div>
    <canvas id="stackedDailyChartTop"></canvas>
  </div>

  <!-- GrÃ¡fico 2 -->
  <div class="chart-container">
    <canvas id="stackedDailyChartEnergy"></canvas>
  </div>
</main>

<script>
  // ---- Config inicial ----
  flatpickr("#dataBase", {
    enableTime: false,
    noCalendar: false,
    dateFormat: "Y-m-d",
    locale: "pt",
    defaultDate: new Date().toISOString().slice(0,10)
  });

  const ORDER_INDEX_TOP = { horas_operacao: 0, num_tachadas: 1 };

  const MEASURES_TOP = [
    { key: "horas_operacao", label: "Horas de operaÃ§Ã£o", unit:"h"  },
    { key: "num_tachadas",   label: "NÂº de tachadas",    unit:""   }
  ];
  const MEASURE_ENERGY = { key: "energia_kWh", label: "Energia", unit: "kWh" };

  const COLOR = {
    energia_kWh:   ["#3BA0FF", "#1D6FD1"],
    horas_operacao:["#34D399", "#1E9C74"],
    num_tachadas:  ["#F59E0B", "#C47A05"]
  };

  let chartTop = null;
  let chartEnergy = null;

  function formatPtBr(n, dec=0) {
    if (n === null || n === undefined || isNaN(n)) return "";
    return Number(n).toLocaleString("pt-BR", { minimumFractionDigits: dec, maximumFractionDigits: dec });
  }

  function buildLabels(json) {
    return Object.keys(json).sort();
  }

  function buildTopDatasets(json, dates) {
    const datasets = [];
    for (const m of MEASURES_TOP) {
      datasets.push({
        label: `${m.label} â€” M1`,
        stack: m.key,
        backgroundColor: COLOR[m.key][0],
        data: dates.map(d => json[d]?.Masseira_1?.[m.key] ?? 0)
      });
      datasets.push({
        label: `${m.label} â€” M2`,
        stack: m.key,
        backgroundColor: COLOR[m.key][1],
        data: dates.map(d => json[d]?.Masseira_2?.[m.key] ?? 0)
      });
    }
    return datasets;
  }

  function buildEnergyDatasets(json, dates) {
    return [
      {
        label: `${MEASURE_ENERGY.label} â€” M1`,
        stack: MEASURE_ENERGY.key,
        backgroundColor: COLOR.energia_kWh[0],
        data: dates.map(d => json[d]?.Masseira_1?.energia_kWh ?? 0)
      },
      {
        label: `${MEASURE_ENERGY.label} â€” M2`,
        stack: MEASURE_ENERGY.key,
        backgroundColor: COLOR.energia_kWh[1],
        data: dates.map(d => json[d]?.Masseira_2?.energia_kWh ?? 0)
      }
    ];
  }

  function computeTachadasTotals(json, dates) {
    const byDay = dates.map(d =>
      (json[d]?.Masseira_1?.num_tachadas ?? 0) + (json[d]?.Masseira_2?.num_tachadas ?? 0)
    );
    const sumAll = byDay.reduce((a,b)=>a+b, 0);
    return { byDay, sumAll };
  }

  async function fetchDaily(periodo, dataBase) {
    const url = `/api/daily_tachadas?periodo=${encodeURIComponent(periodo)}&data_base=${encodeURIComponent(dataBase)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Erro API: ${res.status}`);
    return await res.json();
  }

  function makeTopChart(config, totalsPerDay, overallPercent) {
    const canvas = document.getElementById("stackedDailyChartTop");
    const ctx = canvas.getContext("2d");

    // ðŸ”§ Destroi o grÃ¡fico anterior, se existir
    const existing = Chart.getChart(canvas);
    if (existing) existing.destroy();

    Chart.register(ChartDataLabels);

    const options = {
      responsive: true,
      animation: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: "#e0e0e0" } },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const ds = ctx.dataset;
              const val = formatPtBr(ctx.parsed.y);
              const unit = /Horas/.test(ds.label) ? " h" : "";
              return `${ds.label}: ${val}${unit}`;
            },
            afterBody: (items) => {
              if (!items?.length) return;
              const idx = items[0].dataIndex;
              const p = totalsPerDay[idx] ? (totalsPerDay[idx] / 16) * 100 : 0;
              return `Capacidade do dia: ${Math.round(p)}%`;
            }
          }
        },
        annotation: {
          annotations: {
            capacidade: {
              type: 'line',
              yMin: 16,
              yMax: 16,
              borderColor: '#e0e0e0',
              borderWidth: 2,
              borderDash: [6, 6],
              label: {
                display: true,
                content: 'Capacidade produtiva (16)',
                color: '#e0e0e0',
                backgroundColor: 'rgba(0,0,0,0.5)',
                position: 'end',
                xAdjust: -6,
                yAdjust: -6
              }
            }
          }
        },
        datalabels: {
          display: (ctx) => {
            const ds = ctx.dataset;
            return ds.stack === 'num_tachadas' && /â€” M2$/.test(ds.label);
          },
          formatter: (value, ctx) => {
            const i = ctx.dataIndex;
            const p = totalsPerDay[i] ? (totalsPerDay[i] / 16) * 100 : 0;
            return `${Math.round(p)}%`;
          },
          align: 'end',
          anchor: 'end',
          offset: 4,
          color: '#e0e0e0',
          font: { weight: '700' },
          clip: false
        }
      },
      scales: {
        x: { stacked: true, ticks: { color: "#cfcfcf" }, grid: { color: "#333" } },
        y: {
          stacked: true,
          ticks: { color: "#cfcfcf", callback: (v) => formatPtBr(v) },
          grid: { color: "#333" },
          title: { display: true, text: "Horas / NÂº de tachadas", color: "#cfcfcf" }
        }
      }
    };

    chartTop = new Chart(ctx, { type: "bar", data: config, options });

    const badge = document.getElementById('metricCapacidadeValor');
    badge.textContent = isFinite(overallPercent)
      ? `${formatPtBr(Math.round(overallPercent), 0)}%`
      : 'â€“';
  }

  function makeEnergyChart(config) {
    const canvas = document.getElementById("stackedDailyChartEnergy");
    const ctx = canvas.getContext("2d");

    const existing = Chart.getChart(canvas);
    if (existing) existing.destroy();

    chartEnergy = new Chart(ctx, {
      type: "bar",
      data: config,
      options: {
        responsive: true,
        animation: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#e0e0e0" } },
           datalabels: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const ds = ctx.dataset;
                const val = formatPtBr(ctx.parsed.y);
                return `${ds.label}: ${val} kWh`;
              }
            }
          }
        },
        scales: {
          x: { stacked: true, ticks: { color: "#cfcfcf" }, grid: { color: "#333" } },
          y: {
            stacked: true,
            ticks: { color: "#cfcfcf", callback: (v) => formatPtBr(v) },
            grid: { color: "#333" },
            title: { display: true, text: "Energia (kWh)", color: "#cfcfcf" }
          }
        }
      }
    });
  }

  let isLoading = false; // prevent overlapping calls

  async function load() {
    if (isLoading) return; // â›” skip if a load is already running
    isLoading = true;

    const btn = document.getElementById("btnCarregar");
    btn.disabled = true;
    btn.textContent = "Carregando...";

    try {
      const periodo = document.getElementById("periodo").value || "30d";
      const dataBase = document.getElementById("dataBase").value || new Date().toISOString().slice(0,10);
      const json = await fetchDaily(periodo, dataBase);
      const labels = buildLabels(json);
      const { byDay: totalsPerDay, sumAll } = computeTachadasTotals(json, labels);
      const days = labels.length || 1;
      const overallPercent = (sumAll / (16 * days)) * 100;

      const topDatasets = buildTopDatasets(json, labels);
      const energyDatasets = buildEnergyDatasets(json, labels);

      makeTopChart({ labels, datasets: topDatasets }, totalsPerDay, overallPercent);
      makeEnergyChart({ labels, datasets: energyDatasets });

    } catch (e) {
      console.error(e);
      alert("Falha ao carregar dados");
    } finally {
      isLoading = false;
      btn.disabled = false;
      btn.textContent = "Carregar";
    }
  }


  document.getElementById("btnCarregar").addEventListener("click", load);
  load(); // primeira carga
</script>

</body>
</html>
