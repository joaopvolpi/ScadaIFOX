<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dados Históricos</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <style>
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .date-range {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .chart-container {
      background: #1f1f1f;
      border: 1px solid #333;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    canvas {
      width: 100% !important;
      height: 600px !important;
      background: #121212;
      border: 1px solid #333;
      border-radius: 6px;
    }    
  </style>
</head>
<body>
{% set page_title = "  - Masseiras - Dados Históricos" %}
{% include "header.html" %}

  <main>
    <div class="filters">
      <label>Masseira:
        <select id="device">
          <option value="Masseira_1">Masseira 1</option>
          <option value="Masseira_2">Masseira 2</option>
        </select>
      </label>

      <br><br>

      <label>Tags:</label><br>
      <label><input type="checkbox" value="RPM" checked> RPM</label>
      <label><input type="checkbox" value="OutputFrequency" checked> Output Frequency</label>
      <label><input type="checkbox" value="CurrentMagnitude" checked> Current Magnitude</label>
      <label><input type="checkbox" value="PercentageLoad" checked> Percentage Load</label>
      <label><input type="checkbox" value="OutputPower" checked> Output Power</label>

      <div class="date-range">
        <label>De:
          <input type="text" id="start">
        </label>
        <label>Até:
          <input type="text" id="end">
        </label>
        <button onclick="loadHistory()">Carregar</button>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="historyChart"></canvas>
    </div>
  </main>

  <script>
    flatpickr("#start", {
      enableTime: true,
      noCalendar: false,
      dateFormat: "d/m/Y H:i",
      time_24hr: true,
      locale: "pt"
    });
    flatpickr("#end", {
      enableTime: true,
      noCalendar: false,
      dateFormat: "d/m/Y H:i",
      time_24hr: true,
      locale: "pt"
    });

    let chart;

    async function loadHistory() {
      const device = document.getElementById("device").value;
      const checkedTags = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);

      const start = document.getElementById("start")._flatpickr.input.value;
      const end = document.getElementById("end")._flatpickr.input.value;

      const startISO = start ? toISO(start) : "2000-01-01T00:00:00";
      const endISO = end ? toISO(end) : "2100-01-01T00:00:00";

      const params = new URLSearchParams();
      params.append("device", device);
      checkedTags.forEach(tag => params.append("tag", tag));
      params.append("start", startISO);
      params.append("end", endISO);

      const res = await fetch(`/api/history?${params.toString()}`);
      const data = await res.json();

      const timestamps = [];
      const datasets = Object.keys(data).map(tag => {
        const points = data[tag].map(r => {
          const dateStr = r.timestamp.replace(' ', 'T');
          const x = new Date(dateStr);
          const y = Number(r.value);
          timestamps.push(x);
          return { x, y };
        });

        return {
          label: tag,
          data: points,
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.1
        };
      });

      let minTime, maxTime;
      if (timestamps.length > 0) {
        minTime = new Date(Math.min(...timestamps));
        maxTime = new Date(Math.max(...timestamps));
      }

      const ctx = document.getElementById("historyChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          parsing: false,
          responsive: true,
          plugins: {
            legend: { labels: { color: "#e0e0e0" } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const date = new Date(context.parsed.x);
                  return `${context.dataset.label}: ${context.parsed.y} em ${date.toLocaleString('pt-BR')}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: "time",
              time: {
                tooltipFormat: 'dd/MM HH:mm',
                displayFormats: {
                  second: 'dd/MM HH:mm',
                  minute: 'dd/MM HH:mm',
                  hour: 'dd/MM HH:mm'
                }
              },
              title: { display: true, text: "Tempo", color: "#e0e0e0" },
              ticks: { color: "#c0c0c0" },
              grid: { color: "#333" },
              ...(minTime && maxTime ? { min: minTime, max: maxTime } : {})
            },
            y: {
              title: { display: true, text: "Valor", color: "#e0e0e0" },
              ticks: { color: "#c0c0c0" },
              grid: { color: "#333" }
            }
          }
        }
      });
    }

    function toISO(dateStr) {
      const [day, month, yearAndTime] = dateStr.split('/');
      const [year, time] = yearAndTime.split(' ');
      return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}T${time}:00`;
    }

    function getRandomColor() {
      const colors = ["#00bfff", "#28a745", "#ffc107", "#ff4500", "#9370db"];
      return colors[Math.floor(Math.random() * colors.length)];
    }
  </script>
</body>
</html>
