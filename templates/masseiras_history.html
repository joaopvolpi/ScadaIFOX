<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dados Históricos</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>

  <style>
    body {
      font-family: Montserrat, sans-serif;
      margin: 0;
      background: #f5f5f5;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      background: #fff;
      padding: 10px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    header img {
      height: 50px;
    }
    h1 {
      margin: 0 0 0 15px;
      font-size: 1.5em;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .filters {
      margin-bottom: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .date-range {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    input[type="text"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 7px 14px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .chart-container {
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 8px;
    }
    canvas {
      width: 100% !important;
      height: 600px !important;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/27d767_08537cbec0e841f784ee8e484439ef54~mv2.png/v1/fill/w_428,h_102,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Logo%20IF%20Oxicolor%20-%20Institucional%20Cor%20Site.png" alt="Logo IF Oxicolor">
    <h1>  -  Dados Históricos</h1>
    <select id="pageSelect" onchange="location.href=this.value" style="margin-left:auto; padding:5px;">
      <option value="/">Menu Principal</option>
      <option value="/masseiras_live">Masseiras - Ao vivo</option>
      <option value="/masseiras_history">Masseiras - Dados Históricos</option>
      <option value="/tanques_live">Tanques - Ao vivo</option>
      <option value="/tanques_history">Tanques - Histórico</option>
    </select>

    <script>
      // Set dropdown selected based on current URL
      const currentPath = window.location.pathname;
      const select = document.getElementById("pageSelect");
      for (let option of select.options) {
        if (option.value === currentPath) {
          option.selected = true;
          break;
        }
      }
    </script>
  </header>

  <main>
    <div class="filters">
      <label>Masseira:
        <select id="device">
          <option value="Masseira_1">Masseira 1</option>
          <option value="Masseira_2">Masseira 2</option>
        </select>
      </label>

      <br><br>

      <label>Tags:</label><br>
      <label><input type="checkbox" value="RPM" checked> RPM</label>
      <label><input type="checkbox" value="OutputFrequency" checked> Output Frequency</label>
      <label><input type="checkbox" value="CurrentMagnitude" checked> Current Magnitude</label>
      <label><input type="checkbox" value="PercentageLoad" checked> Percentage Load</label>
      <label><input type="checkbox" value="OutputPower" checked> Output Power</label>

      <div class="date-range">
        <label>De:
          <input type="text" id="start">
        </label>
        <label>Até:
          <input type="text" id="end">
        </label>
        <button onclick="loadHistory()">Carregar</button>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="historyChart"></canvas>
    </div>
  </main>

  <script>
    // Init Flatpickr
    flatpickr("#start", {
      enableTime: true,
      noCalendar: false,
      dateFormat: "d/m/Y H:i",
      time_24hr: true,
      locale: "pt"
    });
    flatpickr("#end", {
      enableTime: true,
      noCalendar: false,
      dateFormat: "d/m/Y H:i",
      time_24hr: true,
      locale: "pt"
    });

    let chart;

    async function loadHistory() {
      const device = document.getElementById("device").value;
      const checkedTags = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);

      const start = document.getElementById("start")._flatpickr.input.value;
      const end = document.getElementById("end")._flatpickr.input.value;

      // Convert dd/MM/yyyy HH:mm to ISO
      const startISO = start ? toISO(start) : "2000-01-01T00:00:00";
      const endISO = end ? toISO(end) : "2100-01-01T00:00:00";

      const params = new URLSearchParams();
      params.append("device", device);
      checkedTags.forEach(tag => params.append("tag", tag));
      params.append("start", startISO);
      params.append("end", endISO);

      const res = await fetch(`/api/history?${params.toString()}`);
      const data = await res.json();

      const timestamps = [];
      const datasets = Object.keys(data).map(tag => {
        const points = data[tag].map(r => {
          const dateStr = r.timestamp.replace(' ', 'T');
          const x = new Date(dateStr);
          const y = Number(r.value);
          timestamps.push(x);
          return { x, y };
        });

        return {
          label: tag,
          data: points,
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.1
        };
      });

      let minTime, maxTime;
      if (timestamps.length > 0) {
        minTime = new Date(Math.min(...timestamps));
        maxTime = new Date(Math.max(...timestamps));
      }

      const ctx = document.getElementById("historyChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          parsing: false,
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const date = new Date(context.parsed.x);
                  return `${context.dataset.label}: ${context.parsed.y} em ${date.toLocaleString('pt-BR')}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: "time",
              time: {
                tooltipFormat: 'dd/MM HH:mm',
                displayFormats: {
                  second: 'dd/MM HH:mm',
                  minute: 'dd/MM HH:mm',
                  hour: 'dd/MM HH:mm'
                }
              },
              title: {
                display: true,
                text: "Tempo"
              },
              ...(minTime && maxTime ? { min: minTime, max: maxTime } : {})
            },
            y: {
              title: {
                display: true,
                text: "Valor"
              }
            }
          }
        }
      });
    }

    function toISO(dateStr) {
      const [day, month, yearAndTime] = dateStr.split('/');
      const [year, time] = yearAndTime.split(' ');
      return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}T${time}:00`;
    }

    function getRandomColor() {
      return '#' + Math.floor(Math.random() * 16777215).toString(16);
    }
  </script>
</body>
</html>
