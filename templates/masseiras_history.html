<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dados Históricos</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <style>
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .date-range {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .chart-container {
      background: #1f1f1f;
      border: 1px solid #333;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    canvas {
      width: 100% !important;
      height: 600px !important;
      background: #121212;
      border: 1px solid #333;
      border-radius: 6px;
    }    
  </style>
</head>
<body>
{% set page_title = "  - Masseiras - Dados Históricos" %}
{% include "header.html" %}

  <main>
    <div class="filters">
      <label>Masseira:
        <select id="device">
          <option value="Masseira_1">Masseira 1</option>
          <option value="Masseira_2">Masseira 2</option>
        </select>
      </label>

      <br><br>

      <label>Tags:</label><br>
      <label><input type="checkbox" value="RPM"> RPM</label>
      <label><input type="checkbox" value="OutputFrequency" checked> Output Frequency</label>
      <label><input type="checkbox" value="CurrentMagnitude" checked> Current Magnitude</label>
      <label><input type="checkbox" value="PercentageLoad"> Percentage Load</label>
      <label><input type="checkbox" value="OutputPower"> Output Power</label>

      <div class="date-range">
        <label>De:
          <input type="text" id="start">
        </label>
        <label>Até:
          <input type="text" id="end">
        </label>
        <button onclick="loadHistory()">Carregar</button>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="historyChart"></canvas>
    </div>
  </main>

  <script>
    const now = new Date();
    const start_default = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 0)
    const end_default = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 17, 0)

    flatpickr("#start", {
      enableTime: true, noCalendar: false, dateFormat: "d/m/Y H:i", time_24hr: true, locale: "pt",  defaultDate: start_default
    });
    flatpickr("#end", {
      enableTime: true, noCalendar: false, dateFormat: "d/m/Y H:i", time_24hr: true, locale: "pt",  defaultDate: end_default
    });

    let chart;

    Chart.defaults.elements.line.borderWidth = 2;

    function formatAsLocalWallClock(ms) {
      const d = new Date(ms);
      const day   = String(d.getUTCDate()).padStart(2,'0');
      const month = String(d.getUTCMonth()+1).padStart(2,'0');
      const hour  = String(d.getUTCHours()).padStart(2,'0');
      const min   = String(d.getUTCMinutes()).padStart(2,'0');
      return `${day}/${month} ${hour}:${min}`;
    }

    async function loadHistory() {
      const device = document.getElementById("device").value;
      const checkedTags = Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);

      const start = document.getElementById("start")._flatpickr.input.value;
      const end = document.getElementById("end")._flatpickr.input.value;

      const startISO = start ? toISO(start) : "2000-01-01T00:00:00";
      const endISO   = end   ? toISO(end)   : "2100-01-01T00:00:00";

      const params = new URLSearchParams();
      params.append("device", device);
      checkedTags.forEach(tag => params.append("tag", tag));
      params.append("start", startISO);
      params.append("end", endISO);

      const res = await fetch(`/api/history?${params.toString()}`);
      const data = await res.json();

      let minTime = Number.POSITIVE_INFINITY;
      let maxTime = Number.NEGATIVE_INFINITY;

      const datasets = Object.keys(data).map(tag => {
        const points = data[tag].map(r => {
          const x = r.t;      // epoch ms (number) from API
          const y = Number(r.v);
          if (x < minTime) minTime = x;
          if (x > maxTime) maxTime = x;
          return { x, y };
        });

        return {
          label: tag,
          data: points,
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.1,
          pointRadius: 0
        };
      });

      const ctx = document.getElementById("historyChart").getContext("2d");

      if (!chart) {
        chart = new Chart(ctx, {
          type: "line",
          data: { datasets },
          options: {
            parsing: false,
            responsive: true,
            spanGaps: 1000 * 20,
            plugins: {
              legend: { labels: { color: "#e0e0e0" } },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const formatted = formatAsLocalWallClock(context.parsed.x);
                    return `${context.dataset.label}: ${context.parsed.y} em ${formatted}`;
                  }
                }
              }
            },
            scales: {
              x: {
                type: "time",
                time: {
                  tooltipFormat: 'dd/MM HH:mm',
                  displayFormats: { minute:'dd/MM HH:mm', hour:'dd/MM HH:mm' }
                },
                ticks: {
                  color: "#c0c0c0",
                  callback: (val, idx) => formatAsLocalWallClock(val)
                },
                grid: { color: "#333" },
                ...(isFinite(minTime) && isFinite(maxTime) ? { min: minTime, max: maxTime } : {}),
              },
              y: {
                title: { display: true, text: "Valor", color: "#e0e0e0" },
                ticks: { color: "#c0c0c0" },
                grid: { color: "#333" }
              }
            }
          }
        });
      } else {
        // Update IN PLACE (no destroy/recreate)
        chart.data.datasets = datasets;
        if (isFinite(minTime) && isFinite(maxTime)) {
          chart.options.scales.x.min = minTime;
          chart.options.scales.x.max = maxTime;
        } else {
          delete chart.options.scales.x.min;
          delete chart.options.scales.x.max;
        }
        chart.update('none'); 
      }
    }

    function toISO(dateStr) {
      const [day, month, yearAndTime] = dateStr.split('/');
      const [year, time] = yearAndTime.split(' ');
      return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}T${time}:00`;
    }

    function getRandomColor() {
      const colors = ["#00bfff", "#28a745", "#ffc107", "#ff4500", "#9370db"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    window.addEventListener("DOMContentLoaded", () => {
    loadHistory();
    });

  </script>

</body>
</html>
